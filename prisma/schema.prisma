// Pathshala Design Studio - Database Schema
// Common LFA Platform for Shikshagraha

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================

model Organization {
  id                String   @id @default(uuid())
  name              String
  type              OrgType  @default(NGO)
  state             String?
  district          String?
  yearsOfExperience Int?     @map("years_of_experience")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  users    User[]
  projects LfaProject[]

  @@map("organizations")
}

enum OrgType {
  NGO
  CSO
  GOVERNMENT
  FUNDER
  OTHER
}

model User {
  id                 String   @id @default(uuid())
  email              String   @unique
  name               String?
  password           String
  role               UserRole @default(DESIGNER)
  gamificationPoints Int      @default(0) @map("gamification_points")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])

  badges          UserBadge[]
  createdProjects LfaProject[]
  comments        Comment[]
  versionChanges  VersionHistory[]

  @@map("users")
}

enum UserRole {
  ADMIN
  DESIGNER
  VIEWER
}

model UserBadge {
  id       String   @id @default(uuid())
  badgeId  String   @map("badge_id")
  earnedAt DateTime @default(now()) @map("earned_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@map("user_badges")
}

// ============================================
// LFA PROJECT MANAGEMENT
// ============================================

model LfaProject {
  id                   String        @id @default(uuid())
  title                String
  theme                ProjectTheme  @default(FLN)
  status               ProjectStatus @default(DRAFT)
  completionPercentage Int           @default(0) @map("completion_percentage")
  geography            Json?         // {state, districts[], blocks[]}
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdById String @map("created_by_id")
  createdBy   User   @relation(fields: [createdById], references: [id])

  components   LfaComponent[]
  stakeholders StakeholderMapping[]
  indicators   Indicator[]
  comments     Comment[]
  versions     VersionHistory[]
  progress     ProjectProgress?

  @@map("lfa_projects")
}

enum ProjectTheme {
  FLN
  CAREER_READINESS
  SCHOOL_LEADERSHIP
  CUSTOM
}

enum ProjectStatus {
  DRAFT
  IN_PROGRESS
  REVIEW
  COMPLETE
}

// ============================================
// LFA COMPONENTS
// ============================================

model LfaComponent {
  id            String        @id @default(uuid())
  componentType ComponentType
  content       Json
  version       Int           @default(1)
  isComplete    Boolean       @default(false) @map("is_complete")
  aiSuggestions Json?         @map("ai_suggestions")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  projectId String     @map("project_id")
  project   LfaProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  comments Comment[]
  versions VersionHistory[]

  @@map("lfa_components")
}

enum ComponentType {
  PROBLEM_DEFINITION
  IMPACT_VISION
  THEORY_OF_CHANGE
  STAKEHOLDER_FRAMEWORK
  IMPLEMENTATION_DESIGN
  MONITORING_EVALUATION
}

// ============================================
// STAKEHOLDER MAPPING
// ============================================

model StakeholderMapping {
  id                 String           @id @default(uuid())
  stakeholderType    StakeholderType  @map("stakeholder_type")
  level              StakeholderLevel
  currentPractice    String?          @map("current_practice")
  desiredPractice    String?          @map("desired_practice")
  practiceIndicators Json?            @map("practice_indicators")
  supportRequired    Json?            @map("support_required")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")

  projectId String     @map("project_id")
  project   LfaProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("stakeholder_mappings")
}

enum StakeholderType {
  STUDENT
  TEACHER
  HEAD_MASTER
  SMC
  PARENT
  CRP
  CRCC
  BRP
  BRCC
  BEO
  DEO
  DIET
  DM
  OTHER
}

enum StakeholderLevel {
  SCHOOL
  CLUSTER
  BLOCK
  DISTRICT
  STATE
}

// ============================================
// INDICATORS
// ============================================

model Indicator {
  id                String        @id @default(uuid())
  name              String
  definition        String?
  indicatorType     IndicatorType @map("indicator_type")
  linkedOutcomeId   String?       @map("linked_outcome_id")
  measurementMethod String?       @map("measurement_method")
  frequency         String?
  dataSource        String?       @map("data_source")
  baselineValue     String?       @map("baseline_value")
  targetValue       String?       @map("target_value")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  projectId String     @map("project_id")
  project   LfaProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("indicators")
}

enum IndicatorType {
  OUTCOME
  OUTPUT
  PROCESS
}

// ============================================
// PATTERN LIBRARY
// ============================================

model PatternLibrary {
  id                 String      @id @default(uuid())
  theme              String
  patternType        PatternType @map("pattern_type")
  title              String
  content            Json
  tags               String[]
  usageCount         Int         @default(0) @map("usage_count")
  rating             Float?
  sourceOrganization String?     @map("source_organization")
  isVerified         Boolean     @default(false) @map("is_verified")
  createdAt          DateTime    @default(now()) @map("created_at")

  @@map("pattern_library")
}

enum PatternType {
  PROBLEM
  OUTCOME
  INDICATOR
  PRACTICE_CHANGE
  ACTIVITY
}

// ============================================
// COLLABORATION
// ============================================

model Comment {
  id         String   @id @default(uuid())
  content    String
  isResolved Boolean  @default(false) @map("is_resolved")
  createdAt  DateTime @default(now()) @map("created_at")

  projectId String     @map("project_id")
  project   LfaProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  componentId String?       @map("component_id")
  component   LfaComponent? @relation(fields: [componentId], references: [id])

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  @@map("comments")
}

model VersionHistory {
  id              String   @id @default(uuid())
  previousContent Json?    @map("previous_content")
  newContent      Json?    @map("new_content")
  changeSummary   String?  @map("change_summary")
  createdAt       DateTime @default(now()) @map("created_at")

  projectId String     @map("project_id")
  project   LfaProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  componentId String?       @map("component_id")
  component   LfaComponent? @relation(fields: [componentId], references: [id])

  changedById String @map("changed_by_id")
  changedBy   User   @relation(fields: [changedById], references: [id])

  @@map("version_history")
}

// ============================================
// GAMIFICATION & PROGRESS
// ============================================

model ProjectProgress {
  id                String   @id @default(uuid())
  currentLevel      Int      @default(1) @map("current_level")
  currentQuest      Int      @default(1) @map("current_quest")
  completedQuests   Json     @default("[]") @map("completed_quests")
  levelProgress     Json     @default("{}") @map("level_progress")
  lastActivityAt    DateTime @default(now()) @map("last_activity_at")
  streakDays        Int      @default(0) @map("streak_days")
  totalPointsEarned Int      @default(0) @map("total_points_earned")

  projectId String     @unique @map("project_id")
  project   LfaProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_progress")
}

// ============================================
// REFERENCE DATA - INDIAN GEOGRAPHY
// ============================================

model IndianState {
  id        String           @id @default(uuid())
  name      String           @unique
  code      String           @unique
  districts IndianDistrict[]

  @@map("indian_states")
}

model IndianDistrict {
  id      String         @id @default(uuid())
  name    String
  stateId String         @map("state_id")
  state   IndianState    @relation(fields: [stateId], references: [id])
  blocks  IndianBlock[]

  @@unique([name, stateId])
  @@map("indian_districts")
}

model IndianBlock {
  id         String         @id @default(uuid())
  name       String
  districtId String         @map("district_id")
  district   IndianDistrict @relation(fields: [districtId], references: [id])

  @@unique([name, districtId])
  @@map("indian_blocks")
}
